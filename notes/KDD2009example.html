<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># To make the html: echo &quot;library(knitr); knit(&#39;KDD2009example.Rmd&#39;)&quot; | R --vanilla ; pandoc KDD2009example.md -o KDD2009example.html</span>
<span class="co"># Example of working with KDD2009 data (just to show library at work).</span>
<span class="co"># For data and details see: https://github.com/WinVector/zmPDSwR/tree/master/KDD2009</span>
<span class="co"># and Chapter 6 of Practical Data Science with R: http://www.amazon.com/Practical-Data-Science/dp/1617291560</span>
<span class="co"># load the data as in the book</span>
dir &lt;-<span class="st"> &#39;~/Documents/work/DataScienceBook/zmPDSwR/KDD2009/&#39;</span>
d &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste</span>(dir,<span class="st">&#39;orange_small_train.data.gz&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>),
                <span class="dt">header=</span>T,<span class="dt">sep=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>,<span class="dt">na.strings=</span><span class="kw">c</span>(<span class="st">&#39;NA&#39;</span>,<span class="st">&#39;&#39;</span>))
churn &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste</span>(dir,<span class="st">&#39;orange_small_train_churn.labels.txt&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>),
                    <span class="dt">header=</span>F,<span class="dt">sep=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)
d$churn &lt;-<span class="st"> </span>churn$V1
appetency &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste</span>(dir,<span class="st">&#39;orange_small_train_appetency.labels.txt&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>),
                        <span class="dt">header=</span>F,<span class="dt">sep=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)
d$appetency &lt;-<span class="st"> </span>appetency$V1
upselling &lt;-<span class="st"> </span><span class="kw">read.table</span>(<span class="kw">paste</span>(dir,<span class="st">&#39;orange_small_train_upselling.labels.txt&#39;</span>,<span class="dt">sep=</span><span class="st">&#39;&#39;</span>),
                        <span class="dt">header=</span>F,<span class="dt">sep=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)
d$upselling &lt;-<span class="st"> </span>upselling$V1
<span class="kw">set.seed</span>(<span class="dv">729375</span>)
d$rgroup &lt;-<span class="st"> </span><span class="kw">runif</span>(<span class="kw">dim</span>(d)[[<span class="dv">1</span>]])
dTrainAll &lt;-<span class="st"> </span><span class="kw">subset</span>(d,rgroup&lt;=<span class="fl">0.9</span>)
dTest &lt;-<span class="st"> </span><span class="kw">subset</span>(d,rgroup&gt;<span class="fl">0.9</span>)
<span class="kw">rm</span>(<span class="dt">list=</span><span class="kw">c</span>(<span class="st">&#39;d&#39;</span>,<span class="st">&#39;churn&#39;</span>,<span class="st">&#39;appetency&#39;</span>,<span class="st">&#39;upselling&#39;</span>,<span class="st">&#39;dir&#39;</span>))
outcomes &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;churn&#39;</span>,<span class="st">&#39;appetency&#39;</span>,<span class="st">&#39;upselling&#39;</span>)
vars &lt;-<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">colnames</span>(dTrainAll),
                <span class="kw">c</span>(outcomes,<span class="st">&#39;rgroup&#39;</span>))
yName &lt;-<span class="st"> &#39;churn&#39;</span>
yTarget &lt;-<span class="st"> </span><span class="dv">1</span>
yCond &lt;-<span class="st"> </span><span class="kw">paste</span>(yName,yTarget,<span class="dt">sep=</span><span class="st">&#39;==&#39;</span>)</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#load some libraries</span>
<span class="kw">library</span>(<span class="st">&#39;vtreat&#39;</span>)  <span class="co"># This library isn&#39;t public yet, intall instructions: http://www.win-vector.com/blog/2014/08/vtreat-designing-a-package-for-variable-treatment/</span>

<span class="co"># try the automatic variable treatment</span>
<span class="kw">set.seed</span>(<span class="dv">239525</span>)
treatments &lt;-<span class="st"> </span><span class="kw">designTreatmentsC</span>(dTrainAll[<span class="kw">sample.int</span>(<span class="dt">n=</span><span class="kw">dim</span>(dTrainAll)[[<span class="dv">1</span>]],<span class="dt">size=</span><span class="dv">2000</span>),],vars,yName,<span class="dv">1</span>)
pruneLevel &lt;-<span class="st"> </span><span class="fl">0.99</span>
treatedTrain &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatments,dTrainAll,
                        <span class="dt">pruneLevel=</span>pruneLevel,<span class="dt">scale=</span><span class="ot">TRUE</span>)
treatedTest &lt;-<span class="st"> </span><span class="kw">prepare</span>(treatments,dTest,
                       <span class="dt">pruneLevel=</span>pruneLevel,<span class="dt">scale=</span><span class="ot">TRUE</span>)
mvars &lt;-<span class="st"> </span><span class="kw">intersect</span>(treatments$vars,<span class="kw">colnames</span>(treatedTrain))</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#load/re-load some libraries</span>
<span class="kw">library</span>(<span class="st">&#39;ggplot2&#39;</span>)
<span class="kw">library</span>(<span class="st">&#39;ROCR&#39;</span>)</code></pre>
<pre><code>## Loading required package: gplots
## KernSmooth 2.23 loaded
## Copyright M. P. Wand 1997-2009
## 
## Attaching package: &#39;gplots&#39;
## 
## The following object is masked from &#39;package:stats&#39;:
## 
##     lowess</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;vtreat&#39;</span>)  <span class="co"># This library isn&#39;t public yet, intall instructions: http://www.win-vector.com/blog/2014/08/vtreat-designin# try a principal components version of the analysis</span>
pcomp &lt;-<span class="st"> </span><span class="kw">prcomp</span>(treatedTrain[,mvars])
goodP &lt;-<span class="st"> </span>pcomp$sdev&gt;<span class="fl">1.0e-2</span>
projection &lt;-<span class="st"> </span>pcomp$rotation[,goodP]
treatedTrainP &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(treatedTrain[,mvars]) %*%<span class="st"> </span>projection)
pvars &lt;-<span class="st"> </span><span class="kw">colnames</span>(treatedTrainP)
treatedTrainP[,yName] =<span class="st"> </span>treatedTrain[,yName]
treatedTestP &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">as.matrix</span>(treatedTest[,mvars]) %*%<span class="st"> </span>projection)
treatedTestP[,yName] =<span class="st"> </span>treatedTest[,yName]
formulaP &lt;-<span class="st"> </span><span class="kw">paste</span>(yCond,<span class="kw">paste</span>(pvars,<span class="dt">collapse=</span><span class="st">&#39; + &#39;</span>),<span class="dt">sep=</span><span class="st">&#39; ~ &#39;</span>)

<span class="co"># simple glm model</span>
modelP &lt;-<span class="st"> </span><span class="kw">glm</span>(formulaP,<span class="dt">data=</span>treatedTrainP,<span class="dt">family=</span><span class="kw">binomial</span>(<span class="dt">link=</span><span class="st">&#39;logit&#39;</span>))
treatedTestP$glmPred &lt;-<span class="st"> </span><span class="kw">predict</span>(modelP,<span class="dt">newdata=</span>treatedTestP,<span class="dt">type=</span><span class="st">&#39;link&#39;</span>)
<span class="kw">ggplot</span>(<span class="dt">data=</span>treatedTestP) +<span class="st"> </span>
<span class="st">   </span><span class="kw">geom_density</span>(<span class="kw">aes_string</span>(<span class="dt">x=</span><span class="st">&#39;glmPred&#39;</span>,<span class="dt">color=</span><span class="kw">paste</span>(<span class="st">&#39;as.factor(&#39;</span>,yName,<span class="st">&#39;)&#39;</span>)))</code></pre>
<div class="figure">
<img src="figure/kddexanalyze.png" alt="plot of chunk kddexanalyze" /><p class="caption">plot of chunk kddexanalyze</p>
</div>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compute AUC aas in chapter 5 of Practical Data Science with R</span>
ROCRpred &lt;-<span class="st"> </span><span class="kw">prediction</span>(treatedTest$glmPred,treatedTest[,yName]==yTarget)</code></pre>
<pre><code>## Error: Format of predictions is invalid.</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(<span class="kw">performance</span>(ROCRpred,<span class="st">&quot;tpr&quot;</span>,<span class="st">&quot;fpr&quot;</span>))</code></pre>
<pre><code>## Error: error in evaluating the argument &#39;x&#39; in selecting a method for function &#39;plot&#39;: Error in performance(ROCRpred, &quot;tpr&quot;, &quot;fpr&quot;) : 
##   object &#39;ROCRpred&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">auc &lt;-<span class="st"> </span><span class="kw">attributes</span>(<span class="kw">performance</span>(ROCRpred,<span class="st">&#39;auc&#39;</span>))$y.values[[<span class="dv">1</span>]]</code></pre>
<pre><code>## Error: object &#39;ROCRpred&#39; not found</code></pre>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(auc)</code></pre>
<pre><code>## Error: object &#39;auc&#39; not found</code></pre>
