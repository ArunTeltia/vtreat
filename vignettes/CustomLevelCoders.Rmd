---
title: "Custom Level Coder"
author: "Nina Zumel, John Mount"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Custom Level Coder}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r fn}
library("vtreat")

# @param v character variable name
# @param vcol character variable levels
# @param zoY numeric outcome as numeric
# @param zC NULL if regression, target outcomes if classification
# @param zTarget postitive character target if classification
# @param weights row/example weights
# @return scored training data column
exampleCoder <- function(v, vcol, 
                         zoY, zC, zTarget, 
                         weights) {
  if(is.null(zC)) {
    # regression case zoY ~ vcol
    d <- data.frame(x = vcol,
                    y = zoY,
                    stringsAsFactors = FALSE)
    m <- lm(y~x, data=d, weights=weights)
    p <- predict(m, newdata=d)
    return(p)
  } else {
    # classificaton case (zC == zTarget) ~ vcol
    d <- data.frame(x = vcol,
                    y = zC==zTarget,
                    stringsAsFactors = FALSE)
    m <- glm(y~x, data=d, weights = weights, family=binomial)
    p <- predict(m, newdata=d, type='link')
    return(p)
  }
}

# example data
# "case" is the outcome, despite the naming https://en.wikipedia.org/wiki/Case-control_study
infert <- datasets::infert
for(ci in c("education", "parity","induced", "case", 
            "spontaneous", "stratum", "pooled.stratum")) {
  infert[[ci]] <- as.character(infert[[ci]])
}
```

```{r cex}
# switching ot oneWayHoldout lost vars (TODO: check on this!)
cfe <- mkCrossFrameCExperiment(dframe = infert, 
                               varlist= c('age', 'pooled.stratum'),
                               outcomename = 'case',
                               outcometarget = '1',
                               codeRestriction = c('clean', 'isBAD', 'catB'),
                               ncross = 10,
                               # splitFunction = oneWayHoldout,
                               customCoders = list('regm' = exampleCoder))
treatments <- cfe$treatments
scoreFrame <- treatments$scoreFrame
trainFrame <- cfe$crossFrame

print(scoreFrame)
head(trainFrame)
summary(trainFrame)


applicationFrame <- prepare(treatments, infert)
head(applicationFrame)
summary(applicationFrame)
```

```{r nex}
infert$case <- as.numeric(infert$case)
cfe <- mkCrossFrameNExperiment(dframe = infert, 
                               varlist= c('age', 'pooled.stratum'),
                               outcomename = 'case',
                               codeRestriction = c('clean', 'isBAD', 'catN'),
                               ncross = 10,
                               # splitFunction = oneWayHoldout,
                               customCoders = list('regm' = exampleCoder))
treatments <- cfe$treatments
scoreFrame <- treatments$scoreFrame
trainFrame <- cfe$crossFrame

print(scoreFrame)
head(trainFrame)
summary(trainFrame)


applicationFrame <- prepare(treatments, infert)
head(applicationFrame)
summary(applicationFrame)
```

