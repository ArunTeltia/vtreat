---
title: "Custom Level Coder"
author: "Nina Zumel, John Mount"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Custom Level Coder}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r dat}
library("vtreat")

# example data
# "case" is the outcome, despite the naming https://en.wikipedia.org/wiki/Case-control_study
infert <- datasets::infert
for(ci in c("education", "parity", "induced", "case", 
            "spontaneous", "stratum", "pooled.stratum")) {
  infert[[ci]] <- as.character(infert[[ci]])
}

# @param v character variable name
# @param vcol character variable levels
# @param y logical outcome
# @param weights row/example weights
# @return scored training data column
exampleCoderC <- function(v, vcol, 
                          y, 
                          weights) {
  # classificaton case y ~ vcol
  d <- data.frame(x = vcol,
                  y = y,
                  stringsAsFactors = FALSE)
  m <- glm(y~x, data=d, weights = weights, family=binomial)
  predict(m, newdata=d, type='link')
}


# @param v character variable name
# @param vcol character variable levels
# @param y numeric outcome
# @param weights row/example weights
# @return scored training data column
exampleCoderN <- function(v, vcol, 
                         y, 
                         weights) {
  # regression case y ~ vcol
  d <- data.frame(x = vcol,
                  y = y,
                  stringsAsFactors = FALSE)
  m <- lm(y~x, data=d, weights=weights)
  predict(m, newdata=d)
}

customCoders = list('c.regc' = exampleCoderC,
                    'n.regn' = exampleCoderN)
```

```{r cex}
cfe <- mkCrossFrameCExperiment(dframe = infert, 
                               varlist= c('age', 'education'),
                               outcomename = 'case',
                               outcometarget = '1',
                               codeRestriction = c('clean', 'isBAD', 'catB'),
                               customCoders = customCoders)
print(cfe$method)
treatments <- cfe$treatments
scoreFrame <- treatments$scoreFrame
trainFrame <- cfe$crossFrame

print(scoreFrame)
head(trainFrame)
summary(trainFrame)
summary(glm(case=='1' ~ education_catB, data = trainFrame, family=binomial))

applicationFrame <- prepare(treatments, infert)
head(applicationFrame)
summary(applicationFrame)

summary(glm(case=='1' ~ education_catB, data = applicationFrame, family=binomial))
```

```{r nex}

infert$case <- as.numeric(infert$case)
cfe <- mkCrossFrameNExperiment(dframe = infert, 
                               varlist= c('age', 'education'),
                               outcomename = 'case',
                               codeRestriction = c('clean', 'isBAD', 'catN'),
                               customCoders = customCoders)
print(cfe$method)
treatments <- cfe$treatments
scoreFrame <- treatments$scoreFrame
trainFrame <- cfe$crossFrame

print(scoreFrame)
head(trainFrame)
summary(trainFrame)




applicationFrame <- prepare(treatments, infert)
head(applicationFrame)
summary(applicationFrame)


```

