---
title: "Grouping Example"
author: "Nina Zumel, Nate Sutton"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vtreat grouping example}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 7)
```

```{r warning=FALSE}
library(ggplot2)
library(vtreat)
set.seed(23255)
```

```{r functions}
#
# takes the frame (d) and the outcome column (d$conc)
# from the global environment
#
showGroupingBehavior = function(groupcol, title) {
  print(title)
  
  # display means of each group
  print("Group means:")
  means = tapply(d$conc, d[[groupcol]], mean)
  print(means)
  print(paste("Standard deviation of group means:", sd(means)))
 
  if(requireNamespace("ggplot2", quietly=TRUE)) {
    dtmp = d
    # because I don't think I can call as.factor through aes_string
    dtmp[[groupcol]] = as.factor(dtmp[[groupcol]])
    plt = ggplot(data=dtmp, aes_string(x="conc", color=groupcol)) +
      geom_density() + ggtitle(paste("Distribution of concentration readings:\n", title))
    print(plt)
    
  # not done. what I need to do is summarize across the dose index, not the time,
    # because the times are all different, but everyone got the same number of
    # doses. dplyr can do this.
  #  plt = ggplot(data=d, aes(x=Time, y=conc, color=groupid)) + 
  #    stat_summary(fun.y="mean", geom="point") + stat_summary(fun.y="mean", geom="line")
    
  }
}

```

```{r}
# panel data for concentration in multiple subjects 
d <- datasets::Theoph

# explore the data

# 0. Look
head(d)

# 1. scatterplot of wt/dose
# (oh interesting, I thought the dose would go up with weight)
# ah. dose is mg/kg
ggplot(d, aes(x=Wt, y=Dose)) + geom_point()
ggplot(d, aes(x=Wt, y=Dose*Wt)) + geom_point()

# 2. concentration density plots by patient
# add an (arbitrary) group id so we get fewer plots per facet
subnum = as.numeric(as.character(d$Subject))
d$groupid = as.factor(subnum %% 3)

ggplot(d, aes(x=Time, y=conc, color=Subject)) + 
  geom_line() + facet_wrap(~groupid) + theme(legend.position="none")

ggplot(d, aes(x=conc, color=Subject)) + geom_density() + 
  facet_wrap(~groupid) + theme(legend.position="none")


# a somewhat arbitrary split of patients. According to help(Thoph):  The ordering is by increasing maximum concentration of theophylline observed.
subnum = as.numeric(as.character(d$Subject))
d$groupid = as.factor(subnum %% 3)

# stratify by patient and outcome
#allows concentration to vary amount individual patients
splitter <- makekWayCrossValidationGroupedByColumn('Subject')
split <- splitter(nrow(d),3,d,d$conc)
attr(split, "splitmethod")
d$splitLabel <- vtreat::getSplitPlanAppLabels(nrow(d),split)


# stratify by outcome only
 #forces concentration to be equivalent
pStrat <- kWayStratifiedY(nrow(d),3,d,d$conc)
attr(pStrat, "splitmethod")
d$stratGroup <- vtreat::getSplitPlanAppLabels(nrow(d),pStrat)


# compare results

# print how the patient rows split into the groups
# Arbitrary grouping
print(table(Subject=d$Subject, groupid=d$groupid))

# Grouped by patient, stratified on y
print(table(Subject=d$Subject, groupid=d$splitLabel))

# Stratified on y only
print(table(Subject=d$Subject, groupid=d$stratGroup))


showGroupingBehavior("groupid", "Arbitrary grouping")
showGroupingBehavior("splitLabel", "Group by patient, stratify on y")
showGroupingBehavior("stratGroup", "Stratify on y only")


