<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Level Coder â€¢ vtreat</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">vtreat</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CustomLevelCoders.html">Custom Level Coder</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Custom Level Coder</h1>
                        <h4 class="author">Nina Zumel, John Mount</h4>
            
            <h4 class="date">2017-08-06</h4>
          </div>

    
    
<div class="contents">
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"vtreat"</span>)

<span class="co"># example data</span>
<span class="co"># "case" is the outcome, despite the naming https://en.wikipedia.org/wiki/Case-control_study</span>
infert &lt;-<span class="st"> </span>datasets::infert
for(ci in <span class="kw">c</span>(<span class="st">"education"</span>, <span class="st">"parity"</span>, <span class="st">"induced"</span>, <span class="st">"case"</span>, 
            <span class="st">"spontaneous"</span>, <span class="st">"stratum"</span>, <span class="st">"pooled.stratum"</span>)) {
  infert[[ci]] &lt;-<span class="st"> </span><span class="kw">as.character</span>(infert[[ci]])
}

<span class="co"># @param v character variable name</span>
<span class="co"># @param vcol character variable levels</span>
<span class="co"># @param y logical outcome</span>
<span class="co"># @param weights row/example weights</span>
<span class="co"># @return scored training data column</span>
exampleCoderC &lt;-<span class="st"> </span>function(v, vcol, 
                          y, 
                          weights) {
  <span class="co"># classificaton case y ~ vcol</span>
  d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> vcol,
                  <span class="dt">y =</span> y,
                  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
  m &lt;-<span class="st"> </span><span class="kw">glm</span>(y~x, <span class="dt">data=</span>d, <span class="dt">weights =</span> weights, <span class="dt">family=</span>binomial)
  <span class="kw">predict</span>(m, <span class="dt">newdata=</span>d, <span class="dt">type=</span><span class="st">'link'</span>)
}


<span class="co"># @param v character variable name</span>
<span class="co"># @param vcol character variable levels</span>
<span class="co"># @param y numeric outcome</span>
<span class="co"># @param weights row/example weights</span>
<span class="co"># @return scored training data column</span>
exampleCoderN &lt;-<span class="st"> </span>function(v, vcol, 
                         y, 
                         weights) {
  <span class="co"># regression case y ~ vcol</span>
  d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> vcol,
                  <span class="dt">y =</span> y,
                  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
  m &lt;-<span class="st"> </span><span class="kw">lm</span>(y~x, <span class="dt">data=</span>d, <span class="dt">weights=</span>weights)
  <span class="kw">predict</span>(m, <span class="dt">newdata=</span>d)
}

customCoders =<span class="st"> </span><span class="kw">list</span>(<span class="st">'c.regc'</span> =<span class="st"> </span>exampleCoderC,
                    <span class="st">'n.regn'</span> =<span class="st"> </span>exampleCoderN)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cfe &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mkCrossFrameCExperiment.html">mkCrossFrameCExperiment</a></span>(<span class="dt">dframe =</span> infert, 
                               <span class="dt">varlist=</span> <span class="kw">c</span>(<span class="st">'age'</span>, <span class="st">'education'</span>),
                               <span class="dt">outcomename =</span> <span class="st">'case'</span>,
                               <span class="dt">outcometarget =</span> <span class="st">'1'</span>,
                               <span class="dt">codeRestriction =</span> <span class="kw">c</span>(<span class="st">'clean'</span>, <span class="st">'isBAD'</span>, <span class="st">'catB'</span>),
                               <span class="dt">customCoders =</span> customCoders)
<span class="kw">print</span>(cfe$method)</code></pre></div>
<pre><code>## [1] "kwaycrossystratified"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">treatments &lt;-<span class="st"> </span>cfe$treatments
scoreFrame &lt;-<span class="st"> </span>treatments$scoreFrame
trainFrame &lt;-<span class="st"> </span>cfe$crossFrame

<span class="kw">print</span>(scoreFrame)</code></pre></div>
<pre><code>##          varName varMoves          rsq        sig needsSplit
## 1      age_clean     TRUE 9.774893e-06 0.95566635      FALSE
## 2 education_regc     TRUE 1.649165e-02 0.02240336       TRUE
## 3 education_catB     TRUE 1.653278e-02 0.02223646       TRUE
##   extraModelDegrees  origName  code
## 1                 0       age clean
## 2                 2 education  regc
## 3                 2 education  catB</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(trainFrame)</code></pre></div>
<pre><code>##   age_clean education_regc education_catB case
## 1        26    -0.40108640    -0.40543268    1
## 2        42     0.27000770     0.26967936    1
## 3        39     0.27000770     0.26967936    1
## 4        34    -0.40108640    -0.40543268    1
## 5        35     0.12531811     0.12260309    1
## 6        36    -0.01767438    -0.01801746    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(trainFrame)</code></pre></div>
<pre><code>##    age_clean     education_regc       education_catB      
##  Min.   :21.00   Min.   :-0.4010864   Min.   :-0.4054327  
##  1st Qu.:28.00   1st Qu.:-0.0974040   1st Qu.:-0.1017816  
##  Median :31.00   Median : 0.0003441   Median : 0.0000009  
##  Mean   :31.50   Mean   : 0.0289491   Mean   : 0.0264629  
##  3rd Qu.:35.25   3rd Qu.: 0.1253181   3rd Qu.: 0.1226031  
##  Max.   :44.00   Max.   : 0.2700077   Max.   : 0.2696794  
##      case          
##  Length:248        
##  Class :character  
##  Mode  :character  
##                    
##                    
## </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">glm</span>(case==<span class="st">'1'</span> ~<span class="st"> </span>education_catB, <span class="dt">data =</span> trainFrame, <span class="dt">family=</span>binomial))</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = case == "1" ~ education_catB, family = binomial, 
##     data = trainFrame)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.2043  -0.9289  -0.8353   1.3824   1.6758  
## 
## Coefficients:
##                Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)     -0.6488     0.1366  -4.750 2.03e-06 ***
## education_catB  -1.7559     1.0475  -1.676   0.0937 .  
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 316.17  on 247  degrees of freedom
## Residual deviance: 313.33  on 246  degrees of freedom
## AIC: 317.33
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">applicationFrame &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatments, infert)
<span class="kw">head</span>(applicationFrame)</code></pre></div>
<pre><code>##   age_clean education_regc education_catB case
## 1        26   -0.006035464   -0.006030413    1
## 2        42   -0.006035464   -0.006030413    1
## 3        39   -0.006035464   -0.006030413    1
## 4        34   -0.006035464   -0.006030413    1
## 5        35   -0.006035464   -0.006041663    1
## 6        36   -0.006035464   -0.006041663    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(applicationFrame)</code></pre></div>
<pre><code>##    age_clean     education_regc      education_catB      
##  Min.   :21.00   Min.   :-0.006035   Min.   :-6.042e-03  
##  1st Qu.:28.00   1st Qu.:-0.006035   1st Qu.:-6.042e-03  
##  Median :31.00   Median :-0.006035   Median :-6.030e-03  
##  Mean   :31.50   Mean   : 0.000000   Mean   :-5.648e-06  
##  3rd Qu.:35.25   3rd Qu.: 0.006868   3rd Qu.: 6.862e-03  
##  Max.   :44.00   Max.   : 0.006868   Max.   : 6.862e-03  
##      case          
##  Length:248        
##  Class :character  
##  Mode  :character  
##                    
##                    
## </code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(<span class="kw">glm</span>(case==<span class="st">'1'</span> ~<span class="st"> </span>education_catB, <span class="dt">data =</span> applicationFrame, <span class="dt">family=</span>binomial))</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = case == "1" ~ education_catB, family = binomial, 
##     data = applicationFrame)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -0.9053  -0.9053  -0.9005   1.4765   1.4823  
## 
## Coefficients:
##                Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)     -0.6871     0.1346  -5.106 3.29e-07 ***
## education_catB   1.0001    20.9003   0.048    0.962    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 316.17  on 247  degrees of freedom
## Residual deviance: 316.17  on 246  degrees of freedom
## AIC: 320.17
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">infert$case &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(infert$case)
cfe &lt;-<span class="st"> </span><span class="kw"><a href="../reference/mkCrossFrameNExperiment.html">mkCrossFrameNExperiment</a></span>(<span class="dt">dframe =</span> infert, 
                               <span class="dt">varlist=</span> <span class="kw">c</span>(<span class="st">'age'</span>, <span class="st">'education'</span>),
                               <span class="dt">outcomename =</span> <span class="st">'case'</span>,
                               <span class="dt">codeRestriction =</span> <span class="kw">c</span>(<span class="st">'clean'</span>, <span class="st">'isBAD'</span>, <span class="st">'catN'</span>),
                               <span class="dt">customCoders =</span> customCoders)
<span class="kw">print</span>(cfe$method)</code></pre></div>
<pre><code>## [1] "kwaycrossystratified"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">treatments &lt;-<span class="st"> </span>cfe$treatments
scoreFrame &lt;-<span class="st"> </span>treatments$scoreFrame
trainFrame &lt;-<span class="st"> </span>cfe$crossFrame

<span class="kw">print</span>(scoreFrame)</code></pre></div>
<pre><code>##          varName varMoves          rsq       sig needsSplit
## 1      age_clean     TRUE 1.246409e-05 0.9558860      FALSE
## 2 education_regn     TRUE 4.214295e-04 0.7476893       TRUE
## 3 education_catN     TRUE 3.792044e-04 0.7602569       TRUE
##   extraModelDegrees  origName  code
## 1                 0       age clean
## 2                 2 education  regn
## 3                 2 education  catN</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(trainFrame)</code></pre></div>
<pre><code>##   age_clean education_regn education_catN case
## 1        26   -0.083333333   -0.083333333    1
## 2        42   -0.004016064   -0.004016064    1
## 3        39   -0.083333333   -0.083333333    1
## 4        34    0.095238095    0.095238095    1
## 5        35   -0.051635112   -0.051635112    1
## 6        36   -0.051635112   -0.051635112    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(trainFrame)</code></pre></div>
<pre><code>##    age_clean     education_regn      education_catN           case       
##  Min.   :21.00   Min.   :-0.083333   Min.   :-0.083333   Min.   :0.0000  
##  1st Qu.:28.00   1st Qu.:-0.029536   1st Qu.:-0.029536   1st Qu.:0.0000  
##  Median :31.00   Median : 0.012821   Median : 0.012821   Median :0.0000  
##  Mean   :31.50   Mean   : 0.004674   Mean   : 0.004674   Mean   :0.3347  
##  3rd Qu.:35.25   3rd Qu.: 0.038462   3rd Qu.: 0.038462   3rd Qu.:1.0000  
##  Max.   :44.00   Max.   : 0.095238   Max.   : 0.095238   Max.   :1.0000</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">applicationFrame &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatments, infert)
<span class="kw">head</span>(applicationFrame)</code></pre></div>
<pre><code>##   age_clean education_regn education_catN case
## 1        26   -0.001344086   -0.001344086    1
## 2        42   -0.001344086   -0.001344086    1
## 3        39   -0.001344086   -0.001344086    1
## 4        34   -0.001344086   -0.001344086    1
## 5        35   -0.001344086   -0.001344086    1
## 6        36   -0.001344086   -0.001344086    1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(applicationFrame)</code></pre></div>
<pre><code>##    age_clean     education_regn      education_catN           case       
##  Min.   :21.00   Min.   :-0.001344   Min.   :-0.001344   Min.   :0.0000  
##  1st Qu.:28.00   1st Qu.:-0.001344   1st Qu.:-0.001344   1st Qu.:0.0000  
##  Median :31.00   Median :-0.001344   Median :-0.001344   Median :0.0000  
##  Mean   :31.50   Mean   : 0.000000   Mean   : 0.000000   Mean   :0.3347  
##  3rd Qu.:35.25   3rd Qu.: 0.001529   3rd Qu.: 0.001529   3rd Qu.:1.0000  
##  Max.   :44.00   Max.   : 0.001529   Max.   : 0.001529   Max.   :1.0000</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
