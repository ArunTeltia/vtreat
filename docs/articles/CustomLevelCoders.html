<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Custom Level Coding in vtreat • vtreat</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">vtreat</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/CustomLevelCoders.html">Custom Level Coding in vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Custom Level Coding in vtreat</h1>
                        <h4 class="author">Nina Zumel, John Mount</h4>
            
            <h4 class="date">2017-08-09</h4>
          </div>

    
    
<div class="contents">
<p>One of the services that <code>vtreat</code> provides is <em>level coding</em> (what we sometimes call <em>impact coding</em>): converting the levels of a categorical variable to a meaningful and concise single numeric variable, rather than coding them as indicator variables (AKA “one-hot encoding”). Level coding can be computationally preferable to one-hot encoding for variables that have an extremely large number of possible levels.</p>
<p>By default, <code>vtreat</code> level codes to the difference between the conditional means and the grand mean (<code>catN</code> variables) when the outcome is numeric, and to the difference to the conditional expectations and the global expectation of the target class (<code>catB</code> variables) when the outcome is categorical. These aren’t the only possible level codings. For example, the <code>ranger</code> package can encode categorical variables as ordinals, sorted by the conditional expectations/means. While this is not a valid encoding for all possible models (it is not valid for linear or logistic regression, for example), it is valid for tree-based methods, and has the advantage of keeping the original levels distinct, which impact coding may not. That is, two levels with the same conditional expectation would be conflated by <code>vtreat</code>’s coding. This may not be a problem – but sometimes, it may.</p>
<p>So the data scientist may want to use a level coding different from what <code>vtreat</code> defaults to. In this article, we will demonstrate how to implement custom level encoders in <code>vtreat</code>. We assume you are familiar with the basics of <code>vtreat</code>: the types of derived variables, how to create and apply a treatment plan, etc.</p>
<p>For our example, we will implement level coders based on partial pooling, or hierarchical/multilevel models (Gelman and Hill, 2007). We’ll leave the details of how partial pooling works to a subsequent article; for now, just think of it as a score that shrinks the estimate of the conditional mean to be closer to the unconditioned mean when there are too few measurements to make an accurate estimate.</p>
<p>We’ll implement our partial pooling encoders using the <code><a href="http://www.rdocumentation.org/packages/lme4/topics/lmer">lmer()</a></code> (multilevel linear regression) and <code><a href="http://www.rdocumentation.org/packages/lme4/topics/glmer">glmer()</a></code> (multilevel generalized linear regression) functions from the <code>lme4</code> package. For our example data, we’ll use radon levels by county for the state of Minnesota (Gelman and Hill, 2007. You can find the original data <a href="http://www.stat.columbia.edu/~gelman/arm/software/">here</a>).</p>
<div id="the-data-radon-levels-in-minnesota" class="section level2">
<h2 class="hasAnchor">
<a href="#the-data-radon-levels-in-minnesota" class="anchor"></a>The Data: Radon levels in Minnesota</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"vtreat"</span>)
<span class="kw">library</span>(<span class="st">"lme4"</span>)</code></pre></div>
<pre><code>## Loading required package: Matrix</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"dplyr"</span>)</code></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"tidyr"</span>)</code></pre></div>
<pre><code>## 
## Attaching package: 'tidyr'</code></pre>
<pre><code>## The following object is masked from 'package:Matrix':
## 
##     expand</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">"ggplot2"</span>)

<span class="co"># example data</span>

srrs =<span class="st"> </span><span class="kw">read.table</span>(<span class="st">"srrs2.dat"</span>, <span class="dt">header=</span><span class="ot">TRUE</span>, <span class="dt">sep=</span><span class="st">","</span>, <span class="dt">stringsAsFactor=</span><span class="ot">FALSE</span>)

<span class="co"># target: log of radon activity (activity)</span>
<span class="co"># grouping variable: county</span>
radonMN =<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(srrs, state==<span class="st">"MN"</span>) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="st">"county"</span>, <span class="st">"activity"</span>) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(activity &gt;<span class="st"> </span><span class="dv">0</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">activity =</span> <span class="kw">log</span>(activity),
         <span class="dt">county =</span> base::<span class="kw">trimws</span>(county)) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">critical =</span> activity&gt;<span class="fl">1.5</span>)

<span class="kw">str</span>(radonMN)</code></pre></div>
<pre><code>## 'data.frame':    916 obs. of  3 variables:
##  $ county  : chr  "AITKIN" "AITKIN" "AITKIN" "AITKIN" ...
##  $ activity: num  0.788 0.788 1.065 0 1.131 ...
##  $ critical: logi  FALSE FALSE FALSE FALSE FALSE FALSE ...</code></pre>
<p>For this example we have three columns of interest:</p>
<ul>
<li>
<code>county</code>: 85 possible values</li>
<li>
<code>activity</code>: the log of the radon reading (numerical outcome)</li>
<li>
<code>critical</code>: <code>TRUE</code> when activity &gt; 1.5 (categorical outcome)</li>
</ul>
<p>The goal is to level code <code>county</code> for either the regression problem (predict the log radon reading) or the categorization problem (predict whether the radon level is “critical”).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">radonMN %&gt;%<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(county) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(<span class="dt">county_activity =</span> <span class="kw">mean</span>(activity),
            <span class="dt">county_critical =</span> <span class="kw">mean</span>(critical),
            <span class="dt">county_readings =</span> <span class="kw"><a href="http://dplyr.tidyverse.org/reference/n.html">n</a></span>()) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(<span class="dt">key =</span> measure, <span class="dt">value=</span>value, 
         county_activity, county_critical, county_readings) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>(<span class="dt">adjust=</span><span class="fl">0.5</span>) +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_rug">geom_rug</a></span>(<span class="dt">sides=</span><span class="st">"b"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(~measure, <span class="dt">ncol=</span><span class="dv">1</span>, <span class="dt">scale=</span><span class="st">"free"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Distribution of county stats"</span>)</code></pre></div>
<p><img src="CustomLevelCoders_files/figure-html/unnamed-chunk-1-1.png" width="672"></p>
<p>As the graph shows, the conditional mean of log radon activity by county ranges from nearly zero to about 3, and the conditional expectation of a critical reading ranges from zero to one. On the other hand, the number of readings per county is quite low for many counties – only one or two – though some counties have a large number of readings. That means some of the conditional expectations are quite uncertain.</p>
</div>
<div id="implementing-level-coders-for-partial-pooling" class="section level2">
<h2 class="hasAnchor">
<a href="#implementing-level-coders-for-partial-pooling" class="anchor"></a>Implementing Level Coders for Partial Pooling</h2>
<p>Let’s implement level coders that use partial pooling to compute the level score.</p>
<p><strong>Regression</strong></p>
<p>For regression problems, the custom coder should be a function that takes as input:</p>
<ul>
<li>
<code>v</code>: a string with the name of the categorical variable</li>
<li>
<code>vcol</code>: the actual categorical column (assumed character)</li>
<li>
<code>y</code>: the numerical outcome column</li>
<li>
<code>weights</code>: a column of row weights</li>
</ul>
<p>The function should return a column of scores (the level codings). In keeping with how the <code>catN</code> and <code>catB</code> variables are calculated, <code>vtreat</code> encodes the custom scores as deviations from the grand mean of the returned column.</p>
<p>For our example, the function builds a <code>lmer</code> model to predict <code>y</code> as a function of <code>vcol</code>, then returns the predictions on the training data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># @param v character variable name</span>
<span class="co"># @param vcol character, indpendent or input variable</span>
<span class="co"># @param y numeric, dependent or outcome variable to predict</span>
<span class="co"># @param weights row/example weights</span>
<span class="co"># @return scored training data column</span>
ppCoderN &lt;-<span class="st"> </span>function(v, vcol, 
                     y, 
                     weights) {
  <span class="co"># regression case y ~ vcol</span>
  d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> vcol,
                  <span class="dt">y =</span> y,
                  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
  m &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/lmer">lmer</a></span>(y ~<span class="st"> </span>(<span class="dv">1</span> |<span class="st"> </span>x), <span class="dt">data=</span>d, <span class="dt">weights=</span>weights)
  <span class="kw">predict</span>(m, <span class="dt">newdata=</span>d)
}</code></pre></div>
<p><strong>Categorization</strong></p>
<p>For categorization problems, the function should assume that <code>y</code> is a logical column, where <code>TRUE</code> is assumed to be the target outcome. This is because <code>vtreat</code> converts the outcome column to a logical while creating the treatment plan.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># @param v character variable name</span>
<span class="co"># @param vcol character, independent or input variable</span>
<span class="co"># @param y logical, dependent or outcome variable to predict</span>
<span class="co"># @param weights row/example weights</span>
<span class="co"># @return scored training data column</span>
ppCoderC &lt;-<span class="st"> </span>function(v, vcol, 
                     y, 
                     weights) {
  <span class="co"># classification case y ~ vcol</span>
  d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> vcol,
                  <span class="dt">y =</span> y,
                  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
  m =<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/lme4/topics/glmer">glmer</a></span>(y ~<span class="st"> </span>(<span class="dv">1</span> |<span class="st"> </span>x), <span class="dt">data=</span>d, <span class="dt">weights=</span>weights, <span class="dt">family=</span>binomial)
  <span class="kw">predict</span>(m, <span class="dt">newdata=</span>d, <span class="dt">type=</span><span class="st">'link'</span>)
}</code></pre></div>
<p>You can then pass the functions in as a named list into either <code>designTreatmentsX</code> or <code>mkCrossFrameXExperiment</code> to build the treatment plan. The format of the key is “[n|c].levelName[.option]*" (right now the only supported option is “center”). The prefacing picks the model type: numeric or regression starts with ‘n.’ and the categorical encoder starts with ‘c.’. Our example coders can be passed in we show below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">customCoders =<span class="st"> </span><span class="kw">list</span>(<span class="st">'n.poolN.center'</span> =<span class="st"> </span>ppCoderN, 
                    <span class="st">'c.poolC.center'</span> =<span class="st"> </span>ppCoderC)</code></pre></div>
</div>
<div id="using-the-custom-coders" class="section level2">
<h2 class="hasAnchor">
<a href="#using-the-custom-coders" class="anchor"></a>Using the Custom Coders</h2>
<p>Let’s build a treatment plan for the regression problem.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># I only want to create the cleaned numeric variables, the isBAD variables,</span>
<span class="co"># and the level codings (not the indicator variables or catP, etc.)</span>
vartypes_I_want =<span class="st"> </span><span class="kw">c</span>(<span class="st">'clean'</span>, <span class="st">'isBAD'</span>, <span class="st">'catN'</span>)

treatplanN =<span class="st"> </span><span class="kw"><a href="../reference/designTreatmentsN.html">designTreatmentsN</a></span>(radonMN, 
                               <span class="dt">varlist =</span> <span class="kw">c</span>(<span class="st">'county'</span>),
                               <span class="dt">outcomename =</span> <span class="st">'activity'</span>,
                              <span class="dt">codeRestriction =</span> vartypes_I_want,
                              <span class="dt">customCoders =</span> customCoders, 
                              <span class="dt">verbose=</span><span class="ot">FALSE</span>)

scoreFrame =<span class="st"> </span>treatplanN$scoreFrame
scoreFrame %&gt;%<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/select.html">select</a></span>(varName, sig, origName, code)</code></pre></div>
<pre><code>##        varName          sig origName  code
## 1 county_poolN 2.318258e-20   county poolN
## 2  county_catN 4.730291e-17   county  catN</code></pre>
<p>Note that the treatment plan returns both the <code>catN</code> variable (default level encoding) and the pooled level encoding (<code>poolN</code>). You can restrict to just using one coding or the other using the <code>codeRestriction</code> argument in <code><a href="../reference/prepare.html">prepare()</a></code>.</p>
<p>Let’s compare the two level encodings.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create a frame with one row for every county,</span>
measframe =<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">county =</span> <span class="kw">unique</span>(radonMN$county),
                       <span class="dt">stringsAsFactors=</span><span class="ot">FALSE</span>)

outframe =<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatplanN, measframe)

<span class="co"># If we wanted only the new pooled level coding,</span>
<span class="co"># (plus any numeric/isBAD variables), we would</span>
<span class="co"># use a codeRestriction:</span>
<span class="co">#</span>
<span class="co"># outframe = prepare(treatplanN, </span>
<span class="co">#                    measframe,</span>
<span class="co">#                    codeRestriction = c('clean', 'isBAD', 'poolN'))</span>


<span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(outframe, <span class="dt">key=</span>scoreType, <span class="dt">value=</span>score, 
       county_poolN, county_catN) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>score)) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>(<span class="dt">adjust=</span><span class="fl">0.5</span>) +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_rug">geom_rug</a></span>(<span class="dt">sides=</span><span class="st">"b"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(~scoreType, <span class="dt">ncol=</span><span class="dv">1</span>, <span class="dt">scale=</span><span class="st">"free_y"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Distribution of scores"</span>)</code></pre></div>
<p><img src="CustomLevelCoders_files/figure-html/nex-1.png" width="672"></p>
<p>Notice that the <code>poolN</code> scores are “tucked in” compared to the <code>catN</code> encoding. In a later article, we’ll show that the counties with the most tucking in (or <em>shrinkage</em>) tend to be those with fewer measurements.</p>
<p>We can also code for the categorical problem.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># For categorical problems, coding is catB</span>
vartypes_I_want =<span class="st"> </span><span class="kw">c</span>(<span class="st">'clean'</span>, <span class="st">'isBAD'</span>, <span class="st">'catB'</span>)

treatplanC =<span class="st"> </span><span class="kw"><a href="../reference/designTreatmentsC.html">designTreatmentsC</a></span>(radonMN, 
                               <span class="dt">varlist =</span> <span class="kw">c</span>(<span class="st">'county'</span>),
                               <span class="dt">outcomename =</span> <span class="st">'critical'</span>,
                               <span class="dt">outcometarget=</span> <span class="ot">TRUE</span>,
                               <span class="dt">codeRestriction =</span> vartypes_I_want,
                               <span class="dt">customCoders =</span> customCoders, 
                               <span class="dt">verbose=</span><span class="ot">FALSE</span>)

outframe =<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatplanC, measframe)

<span class="kw"><a href="http://www.rdocumentation.org/packages/tidyr/topics/gather">gather</a></span>(outframe, <span class="dt">key=</span>scoreType, <span class="dt">value=</span>linkscore, 
       county_poolC, county_catB) %&gt;%
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span>linkscore)) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_density">geom_density</a></span>(<span class="dt">adjust=</span><span class="fl">0.5</span>) +<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_rug">geom_rug</a></span>(<span class="dt">sides=</span><span class="st">"b"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(~scoreType, <span class="dt">ncol=</span><span class="dv">1</span>, <span class="dt">scale=</span><span class="st">"free_y"</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ggtitle</a></span>(<span class="st">"Distribution of link scores"</span>)</code></pre></div>
<p><img src="CustomLevelCoders_files/figure-html/unnamed-chunk-2-1.png" width="672"></p>
<p>Notice that the <code>poolC</code> link scores are even more tucked in compared to the <code>catB</code> link scores, and that the <code>catB</code> scores are multimodal. The smaller link scores means that the pooled model avoids estimates of conditional expectation close to either zero or one, because, again, these estimates come from counties with few readings.</p>
</div>
<div id="other-considerations" class="section level2">
<h2 class="hasAnchor">
<a href="#other-considerations" class="anchor"></a>Other Considerations</h2>
<p>For this example, we used the <code>lmer4</code> package to create custom level codings. Once calculated, <code>vtreat</code> stores the coding as a lookup table in the treatment plan. <em>This means <code>lmer4</code> is not needed to prepare new data.</em> In general, using a treatment plan is not dependent on any special packages that might have been used to create it, so it can be shared with other users with no extra dependencies.</p>
<p>When using <code>mkCrossFrameXExperiment</code>, note that resulting cross frame will have a slightly different distribution of scores than what the treatment plan produces. This is true even for <code>catB</code> and <code>catN</code> variables. This is because the treatment plan is built using all the data, while the cross frame is built using n-fold cross validation on the data. See <a href="https://winvector.github.io/vtreat/articles/vtreatCrossFrames.html">the cross frame vignette</a> for more details.</p>
</div>
<div id="references" class="section level2">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<p>Gelman, Andrew and Jennifer Hill. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. Cambridge University Press, 2007.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#the-data-radon-levels-in-minnesota">The Data: Radon levels in Minnesota</a></li>
      <li><a href="#implementing-level-coders-for-partial-pooling">Implementing Level Coders for Partial Pooling</a></li>
      <li><a href="#using-the-custom-coders">Using the Custom Coders</a></li>
      <li><a href="#other-considerations">Other Considerations</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
