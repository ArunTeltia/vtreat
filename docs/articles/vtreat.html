<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>vtreat package • vtreat</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="vtreat package">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultiClassVtreat.html">Multi Class vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/VariableImportance.html">vtreat Variable Importance</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>vtreat package</h1>
                        <h4 class="author">John Mount, Nina Zumel</h4>
            
            <h4 class="date">2019-05-05</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/WinVector/vtreat/blob/master/vignettes/vtreat.Rmd"><code>vignettes/vtreat.Rmd</code></a></small>
      <div class="hidden name"><code>vtreat.Rmd</code></div>

    </div>

    
    
<p>‘vtreat’ is a data.frame processor/conditioner that prepares real-world data for predictive modeling in a statistically sound manner. A formal article on the method can be found here: <a href="https://arxiv.org/abs/1611.09477">arXiv:1611.09477 stat.AP</a>.</p>
<p>A ‘vtreat’ clean data frame:</p>
<ul>
<li>Only has numeric columns (other than the outcome).</li>
<li>Has no Infinite/NA/NaN in the effective variable columns.</li>
</ul>
<p>To achieve this a number of techniques are used. Principally:</p>
<ul>
<li><a href="http://www.win-vector.com/blog/2012/07/modeling-trick-impact-coding-of-categorical-variables-with-many-levels/">Impact coding</a></li>
<li><a href="http://www.win-vector.com/blog/2014/12/a-comment-on-preparing-data-for-classifiers/">Encoding category levels as indicators</a></li>
</ul>
<p>For more details see: <a href="http://www.win-vector.com/blog/2014/08/vtreat-designing-a-package-for-variable-treatment/">the ‘vtreat’ article</a> and <a href="http://www.win-vector.com/blog/2015/05/what-is-new-in-the-vtreat-library/">update</a>.</p>
<p>The use pattern is:</p>
<ol style="list-style-type: decimal">
<li>Use <code><a href="../reference/designTreatmentsC.html">designTreatmentsC()</a></code> or <code><a href="../reference/designTreatmentsN.html">designTreatmentsN()</a></code> to design a treatment plan</li>
<li>Use the returned structure with <code><a href="../reference/prepare.html">prepare()</a></code> to apply the plan to data frames.</li>
</ol>
<p>The main feature of ‘vtreat’ is that all data preparation is “y-aware”: it uses the relations of effective variables to the dependent or outcome variable to encode the effective variables.</p>
<p>The structure returned from <code><a href="../reference/designTreatmentsN.html">designTreatmentsN()</a></code> or <code><a href="../reference/designTreatmentsC.html">designTreatmentsC()</a></code> includes a list of “treatments”: objects that encapsulate the transformation process from the original variables to the new “clean” variables.</p>
<p>In addition to the treatment objects <code><a href="../reference/designTreatmentsC.html">designTreatmentsC()</a></code> and <code><a href="../reference/designTreatmentsN.html">designTreatmentsN()</a></code> also return a data frame named <code>scoreFrame</code> which contains columns:</p>
<ul>
<li>
<code>varName</code>: name of new variable</li>
<li>
<code>origName</code>: name of original variable that the variable was derived from (can repeat).</li>
<li>
<code>code</code>: what time of treatment was performed to create the derived variable (useful for filtering).</li>
<li>
<code>varMoves</code>: logical TRUE if the variable varied during training; only variables that move will be in the treated frame.</li>
<li>
<code>sig</code>: linear significance of regressing derived variable against a 0/1 indicator target for numeric targets, logistic regression significance otherwise.</li>
<li>
<code>needsSplit</code>: is the variable a sub model and require out of sample scoring.</li>
</ul>
<p>In all cases we have two undesirable upward biases on the scores:</p>
<ul>
<li>The treated variables view the training data during construction (for setting of NA values, missing values, levels, and more). So this gives an upward bias when trying to measure treated variable utility on training data. Until the data set is at least 1000 good rows we ignore this effect. After 1000 rows we design variables on a pseudo-randomly chosen 80% of the rows and score on the complimentary 20% of the rows.</li>
<li>The scoring procedure itself involves a fit (linear regression for regression or logistic regression for classification). In each of these cases we would like the scoring itself to only be evaluated on variables constructed on held-out data. This is simulated through a cross-validation procedure.</li>
</ul>
<p>‘vtreat’ uses a number of cross-training and jackknife style procedures to try to mitigate these effects. The suggested best practice (if you have enough data) is to split your data randomly into at least the following disjoint data sets:</p>
<ul>
<li>
<strong>Encoding Calibration</strong> : a data set used for the <code><a href="../reference/designTreatmentsC.html">designTreatmentsC()</a></code> or <code><a href="../reference/designTreatmentsN.html">designTreatmentsN()</a></code> step and not used again for training or test.</li>
<li>
<strong>Training</strong> : a data set used (after <code><a href="../reference/prepare.html">prepare()</a></code>) for training your model.</li>
<li>
<strong>Test</strong> : a data set used (after <code><a href="../reference/prepare.html">prepare()</a></code>) for estimating your model’s out of training performance.</li>
</ul>
<p>Taking the extra step to perform the <code><a href="../reference/designTreatmentsC.html">designTreatmentsC()</a></code> or <code><a href="../reference/designTreatmentsN.html">designTreatmentsN()</a></code> on data disjoint from training makes the training data more exchangeable with test and avoids the issue that ‘vtreat’ may be hiding a large number of degrees of freedom in variables it derives from large categoricals.</p>
<p>Some trivial execution examples (not demonstrating any cal/train/test split) are given below. Variables that do not move during hold-out testing are considered “not to move.”</p>
<hr>
<div id="a-categorical-outcome-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-categorical-outcome-example" class="anchor"></a>A Categorical Outcome Example</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(vtreat)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">dTrainC &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">   <span class="dt">z=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="ot">NA</span>,<span class="dv">6</span>),<span class="dt">y=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="ot">FALSE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">FALSE</span>,<span class="ot">TRUE</span>,<span class="ot">TRUE</span>))</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTrainC)</a></code></pre></div>
<pre><code>##      x  z     y
## 1    a  1 FALSE
## 2    a  2 FALSE
## 3    a  3  TRUE
## 4    b  4 FALSE
## 5    b NA  TRUE
## 6 &lt;NA&gt;  6  TRUE</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">dTestC &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTestC)</a></code></pre></div>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">treatmentsC &lt;-<span class="st"> </span><span class="kw"><a href="../reference/designTreatmentsC.html">designTreatmentsC</a></span>(dTrainC,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(dTrainC),<span class="st">'y'</span>,<span class="ot">TRUE</span>)</a></code></pre></div>
<pre><code>## [1] "vtreat 1.4.0 inspecting inputs Sun May  5 07:48:25 2019"
## [1] "designing treatments Sun May  5 07:48:25 2019"
## [1] " have initial level statistics Sun May  5 07:48:25 2019"
## [1] " scoring treatments Sun May  5 07:48:25 2019"
## [1] "have treatment plan Sun May  5 07:48:25 2019"
## [1] "rescoring complex variables Sun May  5 07:48:25 2019"
## [1] "done rescoring complex variables Sun May  5 07:48:25 2019"</code></pre>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(treatmentsC)</a></code></pre></div>
<pre><code>##   origName   varName  code        rsq        sig extraModelDegrees
## 1        x    x_catP  catP 0.54085208 0.03392101                 2
## 2        x    x_catB  catB 0.00000000 1.00000000                 2
## 3        z         z clean 0.25792985 0.14299775                 0
## 4        z   z_isBAD isBAD 0.19087450 0.20766228                 0
## 5        x  x_lev_NA   lev 0.19087450 0.20766228                 0
## 6        x x_lev_x_a   lev 0.08170417 0.40972582                 0
## 7        x x_lev_x_b   lev 0.00000000 1.00000000                 0</code></pre>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(treatmentsC<span class="op">$</span>treatments[[<span class="dv">1</span>]])</a></code></pre></div>
<pre><code>## [1] "vtreat 'Categoric Indicators'('x'(integer,factor)-&gt;character-&gt;'x_lev_NA','x_lev_x_a','x_lev_x_b')"</code></pre>
<p>Here we demonstrate the optional scaling feature of <code><a href="../reference/prepare.html">prepare()</a></code>, which scales and centers all significant variables to mean 0, and slope 1 with respect to y: In other words, it re-scales the variables to “y-units”. This is useful for downstream principal components analysis. Note: variables perfectly uncorrelated with y necessarily have slope 0 and can’t be “scaled” to slope 1, however for the same reason these variables will be insignificant and can be pruned by pruneSig.</p>
<p><code>scale=FALSE</code> by default.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">dTrainCTreated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatmentsC,dTrainC,<span class="dt">pruneSig=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTrainCTreated)</a></code></pre></div>
<pre><code>##       x_catP    x_catB          z   z_isBAD  x_lev_NA  x_lev_x_a x_lev_x_b
## 1 -0.9396225 -1.894112 -2.2158976 -3.161922 -3.161922 -0.6931472         0
## 2 -0.9396225 -1.894112 -1.2086714 -3.161922 -3.161922 -0.6931472         0
## 3 -0.9396225 -1.894112 -0.2014452 -3.161922 -3.161922 -0.6931472         0
## 4  0.4698112 -1.196414  0.8057809 -3.161922 -3.161922  0.6931472         0
## 5  0.4698112 -1.196414  0.0000000 15.809611 -3.161922  0.6931472         0
## 6  1.8792449  8.075166  2.8202333 -3.161922 15.809611  0.6931472         0
##       y
## 1 FALSE
## 2 FALSE
## 3  TRUE
## 4 FALSE
## 5  TRUE
## 6  TRUE</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">varsC &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(dTrainCTreated),<span class="st">'y'</span>)</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="co"># all input variables should be mean 0</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(dTrainCTreated[,varsC,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean)</a></code></pre></div>
<pre><code>##       x_catP       x_catB            z      z_isBAD     x_lev_NA 
## 3.700743e-16 7.401487e-17 7.408715e-17 2.220446e-16 0.000000e+00 
##    x_lev_x_a    x_lev_x_b 
## 0.000000e+00 0.000000e+00</code></pre>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="co"># all slopes should be 1 for variables with dTrainCTreated$scoreFrame$sig&lt;1</span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(varsC,<span class="cf">function</span>(c) { <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/glm">glm</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),<span class="dt">family=</span>binomial,</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">   <span class="dt">data=</span>dTrainCTreated)<span class="op">$</span>coefficients[[<span class="dv">2</span>]]})</a></code></pre></div>
<pre><code>##    x_catP    x_catB         z   z_isBAD  x_lev_NA x_lev_x_a x_lev_x_b 
##         1         1         1         1         1         1        NA</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">dTestCTreated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatmentsC,dTestC,<span class="dt">pruneSig=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTestCTreated)</a></code></pre></div>
<pre><code>##       x_catP    x_catB         z   z_isBAD  x_lev_NA  x_lev_x_a x_lev_x_b
## 1 -0.9396225 -1.894112  6.849138 -3.161922 -3.161922 -0.6931472         0
## 2  0.4698112 -1.196414 16.921400 -3.161922 -3.161922  0.6931472         0
## 3  2.5839618 -1.196414 26.993662 -3.161922 -3.161922  0.6931472         0
## 4  1.8792449  8.075166  0.000000 15.809611 15.809611  0.6931472         0</code></pre>
<hr>
</div>
<div id="a-numeric-outcome-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-numeric-outcome-example" class="anchor"></a>A Numeric Outcome Example</h2>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="co"># numeric example</span></a>
<a class="sourceLine" id="cb19-2" data-line-number="2">dTrainN &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'b'</span>,<span class="ot">NA</span>),</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">   <span class="dt">z=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>,<span class="dv">4</span>,<span class="dv">5</span>,<span class="ot">NA</span>,<span class="dv">7</span>),<span class="dt">y=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">1</span>))</a>
<a class="sourceLine" id="cb19-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTrainN)</a></code></pre></div>
<pre><code>##   x  z y
## 1 a  1 0
## 2 a  2 0
## 3 a  3 0
## 4 a  4 1
## 5 b  5 0
## 6 b NA 1</code></pre>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">dTestN &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">'a'</span>,<span class="st">'b'</span>,<span class="st">'c'</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="ot">NA</span>))</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTestN)</a></code></pre></div>
<pre><code>##      x  z
## 1    a 10
## 2    b 20
## 3    c 30
## 4 &lt;NA&gt; NA</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">treatmentsN =<span class="st"> </span><span class="kw"><a href="../reference/designTreatmentsN.html">designTreatmentsN</a></span>(dTrainN,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(dTrainN),<span class="st">'y'</span>)</a></code></pre></div>
<pre><code>## [1] "vtreat 1.4.0 inspecting inputs Sun May  5 07:48:26 2019"
## [1] "designing treatments Sun May  5 07:48:26 2019"
## [1] " have initial level statistics Sun May  5 07:48:26 2019"
## [1] " scoring treatments Sun May  5 07:48:26 2019"
## [1] "have treatment plan Sun May  5 07:48:26 2019"
## [1] "rescoring complex variables Sun May  5 07:48:26 2019"
## [1] "done rescoring complex variables Sun May  5 07:48:26 2019"</code></pre>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(treatmentsN)</a></code></pre></div>
<pre><code>##   origName   varName  code         rsq       sig extraModelDegrees
## 1        x    x_catP  catP 0.265604250 0.2364864                 2
## 2        x    x_catN  catN 0.117047314 0.4525814                 2
## 3        x    x_catD  catD 0.005613741 0.8731603                 2
## 4        z         z clean 0.336111111 0.1724763                 0
## 5        z   z_isBAD isBAD 0.222222222 0.2855909                 0
## 6        x  x_lev_NA   lev 0.222222222 0.2855909                 0
## 7        x x_lev_x_a   lev 0.173611111 0.3524132                 0
## 8        x x_lev_x_b   lev 0.008333333 0.8456711                 0</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1">dTrainNTreated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatmentsN,dTrainN,</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">                          <span class="dt">pruneSig=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTrainNTreated)</a></code></pre></div>
<pre><code>##   x_catP      x_catN     x_catD           z    z_isBAD   x_lev_NA
## 1   -0.2 -0.17857143 -0.1785714 -0.41904762 -0.0952381 -0.0952381
## 2   -0.2 -0.17857143 -0.1785714 -0.26190476 -0.0952381 -0.0952381
## 3   -0.2 -0.17857143 -0.1785714 -0.10476190 -0.0952381 -0.0952381
## 4   -0.2 -0.17857143 -0.1785714  0.05238095 -0.0952381 -0.0952381
## 5    0.2  0.07142857  0.2380952  0.20952381 -0.0952381 -0.0952381
## 6    0.2  0.07142857  0.2380952  0.00000000  0.5714286 -0.0952381
##    x_lev_x_a   x_lev_x_b y
## 1 -0.1785714 -0.02857143 0
## 2 -0.1785714 -0.02857143 0
## 3 -0.1785714 -0.02857143 0
## 4 -0.1785714 -0.02857143 1
## 5  0.2380952  0.07142857 0
## 6  0.2380952  0.07142857 1</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">varsN &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(dTrainNTreated),<span class="st">'y'</span>)</a>
<a class="sourceLine" id="cb29-2" data-line-number="2"><span class="co"># all input variables should be mean 0</span></a>
<a class="sourceLine" id="cb29-3" data-line-number="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(dTrainNTreated[,varsN,<span class="dt">drop=</span><span class="ot">FALSE</span>],mean) </a></code></pre></div>
<pre><code>##        x_catP        x_catN        x_catD             z       z_isBAD 
## -5.551115e-17 -3.965082e-18 -9.515810e-17  4.757324e-17 -3.967986e-18 
##      x_lev_NA     x_lev_x_a     x_lev_x_b 
## -3.965082e-18  0.000000e+00 -2.974054e-18</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="co"># all slopes should be 1 for variables with treatmentsN$scoreFrame$sig&lt;1</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">sapply</a></span>(varsN,<span class="cf">function</span>(c) { <span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(<span class="st">'y'</span>,c,<span class="dt">sep=</span><span class="st">'~'</span>),</a>
<a class="sourceLine" id="cb31-3" data-line-number="3">   <span class="dt">data=</span>dTrainNTreated)<span class="op">$</span>coefficients[[<span class="dv">2</span>]]}) </a></code></pre></div>
<pre><code>##    x_catP    x_catN    x_catD         z   z_isBAD  x_lev_NA x_lev_x_a 
##         1         1         1         1         1         1         1 
## x_lev_x_b 
##         1</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="co"># prepared frame</span></a>
<a class="sourceLine" id="cb33-2" data-line-number="2">dTestNTreated &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatmentsN,dTestN,</a>
<a class="sourceLine" id="cb33-3" data-line-number="3">                         <span class="dt">pruneSig=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>())</a>
<a class="sourceLine" id="cb33-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTestNTreated)</a></code></pre></div>
<pre><code>##       x_catP      x_catN    x_catD         z z_isBAD x_lev_NA x_lev_x_a
## 1 0.57142857 -0.17857143 0.5000000 10.000000       0        0         1
## 2 0.28571429  0.07142857 0.7071068 20.000000       0        0         0
## 3 0.07142857  0.00000000 0.7071068 30.000000       0        0         0
## 4 0.14285714  0.57142857 0.7071068  3.666667       1        1         0
##   x_lev_x_b
## 1         0
## 2         1
## 3         0
## 4         0</code></pre>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="co"># scaled prepared frame</span></a>
<a class="sourceLine" id="cb35-2" data-line-number="2">dTestNTreatedS &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prepare.html">prepare</a></span>(treatmentsN,dTestN,</a>
<a class="sourceLine" id="cb35-3" data-line-number="3">                         <span class="dt">pruneSig=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(),<span class="dt">scale=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb35-4" data-line-number="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/head">head</a></span>(dTestNTreatedS)</a></code></pre></div>
<pre><code>##   x_catP        x_catN     x_catD         z    z_isBAD   x_lev_NA
## 1   -0.2 -1.785714e-01 -0.1785714 0.9952381 -0.0952381 -0.0952381
## 2    0.2  7.142857e-02  0.2380952 2.5666667 -0.0952381 -0.0952381
## 3    0.5 -1.586033e-17  0.2380952 4.1380952 -0.0952381 -0.0952381
## 4    0.4  5.714286e-01  0.2380952 0.0000000  0.5714286  0.5714286
##    x_lev_x_a   x_lev_x_b
## 1 -0.1785714 -0.02857143
## 2  0.2380952  0.07142857
## 3  0.2380952 -0.02857143
## 4  0.2380952 -0.02857143</code></pre>
<p>Related work:</p>
<ul>
<li>
<a href="https://www.jstor.org/stable/2683780">“A Transformation for Simplifying the Interpretation of Coefficients of Binary Variables in Regression Analysis”</a>, Robert E. Sweeney and Edwin F. Ulveling; The American Statistician, vol. 26, no. 5, pp. 30-32, 1972.</li>
<li>
<a href="http://dl.acm.org/citation.cfm?id=507538">“A preprocessing scheme for high-cardinality categorical attributes in classification and prediction problems”</a> Daniele Micci-Barreca; ACM SIGKDD Explorations, Volume 3 Issue 1, July 2001 Pages 27-32.</li>
<li>
<a href="http://www.win-vector.com/blog/2012/07/modeling-trick-impact-coding-of-categorical-variables-with-many-levels/">“Modeling Trick: Impact Coding of Categorical Variables with Many Levels”</a> Nina Zumel; Win-Vector blog, 2012.</li>
<li>“Big Learning Made Easy – with Counts!”, Misha Bilenko, Cortana Intelligence and Machine Learning Blog, 2015.</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#a-categorical-outcome-example">A Categorical Outcome Example</a></li>
      <li><a href="#a-numeric-outcome-example">A Numeric Outcome Example</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
