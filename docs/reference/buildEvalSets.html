<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Build set carve-up for out-of sample evaluation. — buildEvalSets • vtreat</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>
  
  
<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">vtreat</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="..//index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/WinVector/vtreat">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Build set carve-up for out-of sample evaluation.</h1>
    </div>

    
    <p>Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning).</p>
    

    <pre class="usage"><span class='fu'>buildEvalSets</span>(<span class='no'>nRows</span>, <span class='no'>...</span>, <span class='kw'>dframe</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>splitFunction</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>nSplits</span> <span class='kw'>=</span> <span class='fl'>3</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>nRows</th>
      <td><p>scalar, &gt;=1 number of rows to sample from.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>no additional arguments, declared to forced named binding of later arguments.</p></td>
    </tr>
    <tr>
      <th>dframe</th>
      <td><p>(optional) original data.frame, passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>(optional) numeric vector, outcome variable (possibly to stratify on), passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>splitFunction</th>
      <td><p>(optional) function taking arguments nSplits,nRows,dframe, and y; returning a user desired split.</p></td>
    </tr>
    <tr>
      <th>nSplits</th>
      <td><p>integer, target number of splits.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of lists where the app portion of the sub-lists is a disjoint carve-up of seq_len(nRows) and each list as a train portion disjoint from app.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Also sets attribute "splitmethod" on return value that describes how the split was performed.
attr(returnValue,'splitmethod') is one of: 'notsplit' (data was not split; corner cases
like single row data sets), 'oneway' (leave one out holdout), 'kwaycross' (a simple
partition), 'userfunction' (user supplied function was actually used), or a user specified attribute.
Any user
desired properties (such as stratification on y, or preservation of groups designated by 
original data row numbers) may not apply unless you see that 'userfunction' has been
used.</p>
<p>The intent is the user splitFunction only needs to handle "easy cases" 
and maintain user invariants. If the user splitFunction returns NULL,
throws, or returns an unacceptable carve-up then vtreat::buildEvalSets
returns its own eval set plan.  The signature of splitFunction should
be splitFunction(nRows,nSplits,dframe,y) where nSplits is the number of 
pieces we want in the carve-up, nRows is the number of rows to split,
dframe is the original dataframe (useful for any group control variables),
and y is a numeric vector representing outcome (useful for outcome stratification).</p>
<p>Note that buildEvalSets may not always return a partition (such
as one row dataframes), or if the user split function chooses to make rows eligable for
applicaton a different number of times.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <p><code><a href='kWayCrossValidation.html'>kWayCrossValidation</a></code>, <code><a href='kWayStratifiedY.html'>kWayStratifiedY</a></code>, and <code><a href='makekWayCrossValidationGroupedByColumn.html'>makekWayCrossValidationGroupedByColumn</a></code></p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'># use</span>
<span class='fu'>buildEvalSets</span>(<span class='fl'>200</span>)</div><div class='output co'>#&gt; [[1]]
#&gt; [[1]]$train
#&gt;   [1]   1   2   3   4   6   7  10  11  13  14  17  18  21  22  23  25  26  27
#&gt;  [19]  29  31  36  37  38  39  40  43  44  45  46  47  49  54  56  58  59  60
#&gt;  [37]  61  63  65  66  68  71  73  76  77  78  80  81  82  83  84  85  86  88
#&gt;  [55]  92  93  94  96  97  98  99 101 102 103 104 105 106 107 108 109 110 111
#&gt;  [73] 113 115 116 117 120 121 122 123 124 128 129 130 131 132 133 134 136 138
#&gt;  [91] 139 140 143 144 145 146 148 149 150 151 155 157 158 161 163 164 167 168
#&gt; [109] 169 170 172 173 175 176 177 179 180 181 182 183 184 185 186 187 190 191
#&gt; [127] 193 194 195 196 197 198 199 200
#&gt; 
#&gt; [[1]]$app
#&gt;  [1] 119  91 141  34  75  12  53  35   9 118  51  72  30 166  15 152  70  79 162
#&gt; [20]  50 147 153 165  48 192  69  64 189 137 188  57 135 125 100  41  62  95  89
#&gt; [39] 171  52  20  19 174 114 178  16   5 142  33  42 126 156  87  32  28   8  90
#&gt; [58]  74 160  67 159  24 154  55 127 112
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; [[2]]$train
#&gt;   [1]   1   2   5   8   9  10  11  12  15  16  18  19  20  21  22  23  24  26
#&gt;  [19]  28  30  32  33  34  35  36  39  41  42  43  44  45  48  50  51  52  53
#&gt;  [37]  54  55  56  57  59  60  61  62  63  64  66  67  69  70  72  74  75  76
#&gt;  [55]  77  79  80  81  82  84  85  86  87  88  89  90  91  93  95 100 101 104
#&gt;  [73] 106 109 112 113 114 115 118 119 120 121 124 125 126 127 130 131 134 135
#&gt;  [91] 136 137 139 140 141 142 145 146 147 149 151 152 153 154 155 156 157 159
#&gt; [109] 160 162 163 165 166 167 169 171 174 176 177 178 180 183 184 186 187 188
#&gt; [127] 189 192 194 196 197 199 200
#&gt; 
#&gt; [[2]]$app
#&gt;  [1]  17  31  97 148   7  37  71 122 173  92   6 107 116 181 102 198 191  47  73
#&gt; [20] 103 164  46 128 185   4   3 105 132 193  25 110 195 108 129  40 172  94  78
#&gt; [39] 143  65 123 182 144  14 175  38 158  68 168  13 161  49 179  83  99  96 133
#&gt; [58] 111 150  98 190 117  29 138  27  58 170
#&gt; 
#&gt; 
#&gt; [[3]]
#&gt; [[3]]$train
#&gt;   [1]   3   4   5   6   7   8   9  12  13  14  15  16  17  19  20  24  25  27
#&gt;  [19]  28  29  30  31  32  33  34  35  37  38  40  41  42  46  47  48  49  50
#&gt;  [37]  51  52  53  55  57  58  62  64  65  67  68  69  70  71  72  73  74  75
#&gt;  [55]  78  79  83  87  89  90  91  92  94  95  96  97  98  99 100 102 103 105
#&gt;  [73] 107 108 110 111 112 114 116 117 118 119 122 123 125 126 127 128 129 132
#&gt;  [91] 133 135 137 138 141 142 143 144 147 148 150 152 153 154 156 158 159 160
#&gt; [109] 161 162 164 165 166 168 170 171 172 173 174 175 178 179 181 182 185 188
#&gt; [127] 189 190 191 192 193 195 198
#&gt; 
#&gt; [[3]]$app
#&gt;  [1] 167   2  56 199  60 186 177 131 130 120  39  80 155 109 104 163  59  26 113
#&gt; [20]  10 169  82 146 151 187 149 124 197 106  76 200  77  86  81  22 101 115 196
#&gt; [39]  43 176  45  66 157 183  63  44 140  36  93 136  11  21 121 139 194 145  23
#&gt; [58]   1 184  54  88  61 134  84  18 180  85
#&gt; 
#&gt; 
#&gt; attr(,"splitmethod")
#&gt; [1] "kwaycross"</div><div class='input'>
<span class='co'># longer example</span>
<span class='co'># helper fns</span>
<span class='co'># fit models using experiment plan to estimate out of sample behavior</span>
<span class='no'>fitModelAndApply</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>trainData</span>,<span class='no'>applicaitonData</span>) {
   <span class='no'>model</span> <span class='kw'>&lt;-</span> <span class='fu'>lm</span>(<span class='no'>y</span>~<span class='no'>x</span>,<span class='kw'>data</span><span class='kw'>=</span><span class='no'>trainData</span>)
   <span class='fu'>predict</span>(<span class='no'>model</span>,<span class='kw'>newdata</span><span class='kw'>=</span><span class='no'>applicaitonData</span>)
}
<span class='no'>simulateOutOfSampleTrainEval</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>d</span>,<span class='no'>fitApplyFn</span>) {
   <span class='no'>eSets</span> <span class='kw'>&lt;-</span> <span class='fu'>buildEvalSets</span>(<span class='fu'>nrow</span>(<span class='no'>d</span>))
   <span class='no'>evals</span> <span class='kw'>&lt;-</span> <span class='fu'>lapply</span>(<span class='no'>eSets</span>,
      <span class='kw'>function</span>(<span class='no'>ei</span>) { <span class='fu'>fitApplyFn</span>(<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>train</span>,],<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>app</span>,]) })
   <span class='no'>pred</span> <span class='kw'>&lt;-</span> <span class='fu'>numeric</span>(<span class='fu'>nrow</span>(<span class='no'>d</span>))
   <span class='kw'>for</span>(<span class='no'>eii</span> <span class='kw'>in</span> <span class='fu'>seq_len</span>(<span class='fu'>length</span>(<span class='no'>eSets</span>))) {
     <span class='no'>pred</span>[<span class='no'>eSets</span><span class='kw'>[[</span><span class='no'>eii</span>]]$<span class='no'>app</span>] <span class='kw'>&lt;-</span> <span class='no'>evals</span><span class='kw'>[[</span><span class='no'>eii</span>]]
   }
   <span class='no'>pred</span>
}

<span class='co'># run the experiment</span>
<span class='fu'>set.seed</span>(<span class='fl'>2352356</span>)
<span class='co'># example data</span>
<span class='no'>d</span> <span class='kw'>&lt;-</span> <span class='fu'>data.frame</span>(<span class='kw'>x</span><span class='kw'>=</span><span class='fu'>rnorm</span>(<span class='fl'>5</span>),<span class='kw'>y</span><span class='kw'>=</span><span class='fu'>rnorm</span>(<span class='fl'>5</span>),
        <span class='kw'>outOfSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>,<span class='kw'>inSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>)

<span class='co'># fit model on all data</span>
<span class='no'>d</span>$<span class='no'>inSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>fitModelAndApply</span>(<span class='no'>d</span>,<span class='no'>d</span>)
<span class='co'># compute in-sample R^2 (above zero, falsely shows a </span>
<span class='co'>#   relation until we adjust for degrees of freedom)</span>
<span class='fl'>1</span>-<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>inSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'>mean</span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] 0.4193942</div><div class='input'>
<span class='no'>d</span>$<span class='no'>outOfSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>simulateOutOfSampleTrainEval</span>(<span class='no'>d</span>,<span class='no'>fitModelAndApply</span>)
<span class='co'># compute out-sample R^2 (not positive, </span>
<span class='co'>#  evidence of no relation)</span>
<span class='fl'>1</span>-<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>outOfSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'>mean</span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] -0.568004</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
