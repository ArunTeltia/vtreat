<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Build set carve-up for out-of sample evaluation. — buildEvalSets • vtreat</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Build set carve-up for out-of sample evaluation. — buildEvalSets" />

<meta property="og:description" content="Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning)." />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">1.2.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Build set carve-up for out-of sample evaluation.</h1>
    <small class="dont-index">Source: <a href='https://github.com/WinVector/vtreat//blob/master/R/outOfSample.R'><code>R/outOfSample.R</code></a></small>
    <div class="hidden name"><code>buildEvalSets.Rd</code></div>
    </div>

    <div class="ref-description">
    
    <p>Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning).</p>
    
    </div>

    <pre class="usage"><span class='fu'>buildEvalSets</span>(<span class='no'>nRows</span>, <span class='no'>...</span>, <span class='kw'>dframe</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>splitFunction</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>nSplits</span> <span class='kw'>=</span> <span class='fl'>3</span>)</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>nRows</th>
      <td><p>scalar, &gt;=1 number of rows to sample from.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>no additional arguments, declared to forced named binding of later arguments.</p></td>
    </tr>
    <tr>
      <th>dframe</th>
      <td><p>(optional) original data.frame, passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>(optional) numeric vector, outcome variable (possibly to stratify on), passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>splitFunction</th>
      <td><p>(optional) function taking arguments nSplits,nRows,dframe, and y; returning a user desired split.</p></td>
    </tr>
    <tr>
      <th>nSplits</th>
      <td><p>integer, target number of splits.</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of lists where the app portion of the sub-lists is a disjoint carve-up of seq_len(nRows) and each list as a train portion disjoint from app.</p>
    
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Also sets attribute "splitmethod" on return value that describes how the split was performed.
attr(returnValue,'splitmethod') is one of: 'notsplit' (data was not split; corner cases
like single row data sets), 'oneway' (leave one out holdout), 'kwaycross' (a simple
partition), 'userfunction' (user supplied function was actually used), or a user specified attribute.
Any user
desired properties (such as stratification on y, or preservation of groups designated by 
original data row numbers) may not apply unless you see that 'userfunction' has been
used.</p>
<p>The intent is the user splitFunction only needs to handle "easy cases" 
and maintain user invariants. If the user splitFunction returns NULL,
throws, or returns an unacceptable carve-up then vtreat::buildEvalSets
returns its own eval set plan.  The signature of splitFunction should
be splitFunction(nRows,nSplits,dframe,y) where nSplits is the number of 
pieces we want in the carve-up, nRows is the number of rows to split,
dframe is the original dataframe (useful for any group control variables),
and y is a numeric vector representing outcome (useful for outcome stratification).</p>
<p>Note that buildEvalSets may not always return a partition (such
as one row dataframes), or if the user split function chooses to make rows eligable for
applicaton a different number of times.</p>
    
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='kWayCrossValidation.html'>kWayCrossValidation</a></code>, <code><a href='kWayStratifiedY.html'>kWayStratifiedY</a></code>, and <code><a href='makekWayCrossValidationGroupedByColumn.html'>makekWayCrossValidationGroupedByColumn</a></code></p></div>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'># use</span>
<span class='fu'>buildEvalSets</span>(<span class='fl'>200</span>)</div><div class='output co'>#&gt; [[1]]
#&gt; [[1]]$train
#&gt;   [1]   1   2   4   6   7   8   9  12  13  14  16  17  22  24  25  26  27  28
#&gt;  [19]  29  30  31  32  33  35  36  37  40  41  42  44  48  49  50  52  54  59
#&gt;  [37]  61  62  63  64  66  68  69  70  72  73  74  75  76  79  80  81  82  83
#&gt;  [55]  84  85  86  87  91  92  93  95  97  99 100 103 104 105 106 107 111 112
#&gt;  [73] 113 115 116 117 120 121 122 124 125 126 127 128 129 130 131 133 134 135
#&gt;  [91] 137 139 141 143 145 147 148 149 150 151 152 153 156 157 158 159 160 161
#&gt; [109] 162 163 165 166 167 168 171 173 174 175 177 178 179 181 182 183 184 185
#&gt; [127] 187 188 190 194 195 197 199 200
#&gt; 
#&gt; [[1]]$app
#&gt;  [1]  78 110 102  55 193  11  94  43   5 140  71 109 191 142  56 176  38 169  18
#&gt; [20] 180  77  34  10  23 186 101  88  39  53 154 164 172  89 136  65 170 198 132
#&gt; [39]  58 155  96 108 119   3  15  60 144  57  46 138 196  45 189 118 146  67  21
#&gt; [58]  19  90 114  51  47  98 192  20 123
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; [[2]]$train
#&gt;   [1]   1   2   3   5   8  10  11  12  13  15  16  18  19  20  21  22  23  24
#&gt;  [19]  27  33  34  37  38  39  43  45  46  47  48  50  51  53  54  55  56  57
#&gt;  [37]  58  60  63  64  65  67  71  72  73  74  75  76  77  78  79  81  85  86
#&gt;  [55]  88  89  90  92  93  94  96  98 101 102 103 105 106 108 109 110 113 114
#&gt;  [73] 118 119 122 123 124 125 126 128 129 132 133 135 136 137 138 139 140 142
#&gt;  [91] 144 145 146 147 148 149 150 153 154 155 157 159 161 162 164 165 166 168
#&gt; [109] 169 170 171 172 173 174 175 176 180 181 185 186 187 188 189 190 191 192
#&gt; [127] 193 194 195 196 197 198 199
#&gt; 
#&gt; [[2]]$app
#&gt;  [1]   6   4 167 115  91  40 182 152  97  82  69 112  84 141 158 121 131 163  59
#&gt; [20]  28 120  80 200 179 117  30 151  26  66 104 100 107  31  25 177 178  62   7
#&gt; [39]  42  14  29 111 130  68  87  83  70  52  99  41 127 184  32   9 160 116  44
#&gt; [58] 183  49 134  35  17 156  61  95  36 143
#&gt; 
#&gt; 
#&gt; [[3]]
#&gt; [[3]]$train
#&gt;   [1]   3   4   5   6   7   9  10  11  14  15  17  18  19  20  21  23  25  26
#&gt;  [19]  28  29  30  31  32  34  35  36  38  39  40  41  42  43  44  45  46  47
#&gt;  [37]  49  51  52  53  55  56  57  58  59  60  61  62  65  66  67  68  69  70
#&gt;  [55]  71  77  78  80  82  83  84  87  88  89  90  91  94  95  96  97  98  99
#&gt;  [73] 100 101 102 104 107 108 109 110 111 112 114 115 116 117 118 119 120 121
#&gt;  [91] 123 127 130 131 132 134 136 138 140 141 142 143 144 146 151 152 154 155
#&gt; [109] 156 158 160 163 164 167 169 170 172 176 177 178 179 180 182 183 184 186
#&gt; [127] 189 191 192 193 196 198 200
#&gt; 
#&gt; [[3]]$app
#&gt;  [1]  93  74  75  50 173 124  27 128 147 139  37  85 137   2  79 188  86 129 194
#&gt; [20]  24 148 161 122 149 174 113 181  54 125 165  64  76 126   1  73 135   8 106
#&gt; [39]  22 157 168 199 153  16 103 171  48  63 133 166  33  92 150  81 105 162 195
#&gt; [58]  72 185  12  13 190 145 159 197 175 187
#&gt; 
#&gt; 
#&gt; attr(,"splitmethod")
#&gt; [1] "kwaycross"</div><div class='input'>
<span class='co'># longer example</span>
<span class='co'># helper fns</span>
<span class='co'># fit models using experiment plan to estimate out of sample behavior</span>
<span class='no'>fitModelAndApply</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>trainData</span>,<span class='no'>applicaitonData</span>) {
   <span class='no'>model</span> <span class='kw'>&lt;-</span> <span class='fu'>lm</span>(<span class='no'>y</span>~<span class='no'>x</span>,<span class='kw'>data</span><span class='kw'>=</span><span class='no'>trainData</span>)
   <span class='fu'>predict</span>(<span class='no'>model</span>,<span class='kw'>newdata</span><span class='kw'>=</span><span class='no'>applicaitonData</span>)
}
<span class='no'>simulateOutOfSampleTrainEval</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>d</span>,<span class='no'>fitApplyFn</span>) {
   <span class='no'>eSets</span> <span class='kw'>&lt;-</span> <span class='fu'>buildEvalSets</span>(<span class='fu'>nrow</span>(<span class='no'>d</span>))
   <span class='no'>evals</span> <span class='kw'>&lt;-</span> <span class='fu'>lapply</span>(<span class='no'>eSets</span>,
      <span class='kw'>function</span>(<span class='no'>ei</span>) { <span class='fu'>fitApplyFn</span>(<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>train</span>,],<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>app</span>,]) })
   <span class='no'>pred</span> <span class='kw'>&lt;-</span> <span class='fu'>numeric</span>(<span class='fu'>nrow</span>(<span class='no'>d</span>))
   <span class='kw'>for</span>(<span class='no'>eii</span> <span class='kw'>in</span> <span class='fu'>seq_len</span>(<span class='fu'>length</span>(<span class='no'>eSets</span>))) {
     <span class='no'>pred</span>[<span class='no'>eSets</span><span class='kw'>[[</span><span class='no'>eii</span>]]$<span class='no'>app</span>] <span class='kw'>&lt;-</span> <span class='no'>evals</span><span class='kw'>[[</span><span class='no'>eii</span>]]
   }
   <span class='no'>pred</span>
}

<span class='co'># run the experiment</span>
<span class='fu'>set.seed</span>(<span class='fl'>2352356</span>)
<span class='co'># example data</span>
<span class='no'>d</span> <span class='kw'>&lt;-</span> <span class='fu'>data.frame</span>(<span class='kw'>x</span><span class='kw'>=</span><span class='fu'>rnorm</span>(<span class='fl'>5</span>),<span class='kw'>y</span><span class='kw'>=</span><span class='fu'>rnorm</span>(<span class='fl'>5</span>),
        <span class='kw'>outOfSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>,<span class='kw'>inSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>)

<span class='co'># fit model on all data</span>
<span class='no'>d</span>$<span class='no'>inSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>fitModelAndApply</span>(<span class='no'>d</span>,<span class='no'>d</span>)
<span class='co'># compute in-sample R^2 (above zero, falsely shows a </span>
<span class='co'>#   relation until we adjust for degrees of freedom)</span>
<span class='fl'>1</span>-<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>inSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'>mean</span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] 0.4193942</div><div class='input'>
<span class='no'>d</span>$<span class='no'>outOfSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>simulateOutOfSampleTrainEval</span>(<span class='no'>d</span>,<span class='no'>fitModelAndApply</span>)
<span class='co'># compute out-sample R^2 (not positive, </span>
<span class='co'>#  evidence of no relation)</span>
<span class='fl'>1</span>-<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>outOfSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'>sum</span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'>mean</span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] -0.7843929</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#details">Details</a></li>

      <li><a href="#see-also">See also</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  

  </body>
</html>

