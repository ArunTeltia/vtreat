<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Build set carve-up for out-of sample evaluation. — buildEvalSets • vtreat</title>


<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Build set carve-up for out-of sample evaluation. — buildEvalSets" />
<meta property="og:description" content="Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning)." />
<meta name="twitter:card" content="summary" />




<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vtreat</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.4.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vtreat.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/MultiClassVtreat.html">Multi Class vtreat</a>
    </li>
    <li>
      <a href="../articles/SavingTreamentPlans.html">Saving Treatment Plans</a>
    </li>
    <li>
      <a href="../articles/VariableImportance.html">vtreat Variable Importance</a>
    </li>
    <li>
      <a href="../articles/vtreatCrossFrames.html">vtreat cross frames</a>
    </li>
    <li>
      <a href="../articles/vtreatGrouping.html">Grouping Example</a>
    </li>
    <li>
      <a href="../articles/vtreatOverfit.html">vtreat overfit</a>
    </li>
    <li>
      <a href="../articles/vtreatRareLevels.html">vtreat Rare Levels</a>
    </li>
    <li>
      <a href="../articles/vtreatScaleMode.html">vtreat scale mode</a>
    </li>
    <li>
      <a href="../articles/vtreatSignificance.html">vtreat significance</a>
    </li>
    <li>
      <a href="../articles/vtreatSplitting.html">vtreat splitting</a>
    </li>
    <li>
      <a href="../articles/vtreatVariableTypes.html">Variable Types</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://www.win-vector.com/">Sponsor: Win-Vector LLC</a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Build set carve-up for out-of sample evaluation.</h1>
    <small class="dont-index">Source: <a href='https://github.com/WinVector/vtreat/blob/master/R/outOfSample.R'><code>R/outOfSample.R</code></a></small>
    <div class="hidden name"><code>buildEvalSets.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Return a carve-up of seq_len(nRows).  Very useful for any sort of
nested model situation (such as data prep, stacking, or super-learning).</p>
    </div>

    <pre class="usage"><span class='fu'>buildEvalSets</span>(<span class='no'>nRows</span>, <span class='no'>...</span>, <span class='kw'>dframe</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>y</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>splitFunction</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>nSplits</span> <span class='kw'>=</span> <span class='fl'>3</span>)</pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>nRows</th>
      <td><p>scalar, &gt;=1 number of rows to sample from.</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>no additional arguments, declared to forced named binding of later arguments.</p></td>
    </tr>
    <tr>
      <th>dframe</th>
      <td><p>(optional) original data.frame, passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>y</th>
      <td><p>(optional) numeric vector, outcome variable (possibly to stratify on), passed to user splitFunction.</p></td>
    </tr>
    <tr>
      <th>splitFunction</th>
      <td><p>(optional) function taking arguments nSplits,nRows,dframe, and y; returning a user desired split.</p></td>
    </tr>
    <tr>
      <th>nSplits</th>
      <td><p>integer, target number of splits.</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>list of lists where the app portion of the sub-lists is a disjoint carve-up of seq_len(nRows) and each list as a train portion disjoint from app.</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>Also sets attribute "splitmethod" on return value that describes how the split was performed.
attr(returnValue,'splitmethod') is one of: 'notsplit' (data was not split; corner cases
like single row data sets), 'oneway' (leave one out holdout), 'kwaycross' (a simple
partition), 'userfunction' (user supplied function was actually used), or a user specified attribute.
Any user
desired properties (such as stratification on y, or preservation of groups designated by 
original data row numbers) may not apply unless you see that 'userfunction' has been
used.</p>
<p>The intent is the user splitFunction only needs to handle "easy cases" 
and maintain user invariants. If the user splitFunction returns NULL,
throws, or returns an unacceptable carve-up then vtreat::buildEvalSets
returns its own eval set plan.  The signature of splitFunction should
be splitFunction(nRows,nSplits,dframe,y) where nSplits is the number of 
pieces we want in the carve-up, nRows is the number of rows to split,
dframe is the original dataframe (useful for any group control variables),
and y is a numeric vector representing outcome (useful for outcome stratification).</p>
<p>Note that buildEvalSets may not always return a partition (such
as one row dataframes), or if the user split function chooses to make rows eligible for
application a different number of times.</p>
    <h2 class="hasAnchor" id="see-also"><a class="anchor" href="#see-also"></a>See also</h2>

    <div class='dont-index'><p><code><a href='kWayCrossValidation.html'>kWayCrossValidation</a></code>, <code><a href='kWayStratifiedY.html'>kWayStratifiedY</a></code>, and <code><a href='makekWayCrossValidationGroupedByColumn.html'>makekWayCrossValidationGroupedByColumn</a></code></p></div>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'>
<span class='co'># use</span>
<span class='fu'>buildEvalSets</span>(<span class='fl'>200</span>)</div><div class='output co'>#&gt; [[1]]
#&gt; [[1]]$train
#&gt;   [1]   1   2   3   4   6   7   8   9  11  13  14  18  19  21  22  23  24  28
#&gt;  [19]  29  30  32  33  35  38  40  41  43  44  47  48  49  50  51  52  53  56
#&gt;  [37]  60  62  64  65  66  68  69  70  71  72  73  74  75  76  77  78  79  81
#&gt;  [55]  82  84  85  86  87  88  89  91  92  97  98 100 101 102 103 106 107 108
#&gt;  [73] 109 110 111 112 113 115 116 117 118 119 121 122 124 125 126 127 129 131
#&gt;  [91] 132 133 134 135 136 138 139 142 145 147 148 150 151 152 153 154 155 156
#&gt; [109] 158 159 163 166 169 172 173 174 176 178 179 181 182 183 184 185 186 189
#&gt; [127] 190 191 192 193 195 196 197 199
#&gt; 
#&gt; [[1]]$app
#&gt;  [1]  26   5  17 161  55  36  34 105  25  45 162  94 128  39  12  42  15  58 200
#&gt; [20]  37  83  31  10 146  63  57  59  54 157 104  16 143 198  90 123 140 187 194
#&gt; [39]  95 164 180 141 170  67  99 144  80  93 165 171 160 175 167  27  20 168 120
#&gt; [58] 188  96  46 114 130  61 177 149 137
#&gt; 
#&gt; 
#&gt; [[2]]
#&gt; [[2]]$train
#&gt;   [1]   4   5   6   8   9  10  12  14  15  16  17  20  25  26  27  31  32  33
#&gt;  [19]  34  36  37  39  42  45  46  50  51  52  54  55  57  58  59  61  62  63
#&gt;  [37]  65  66  67  68  69  70  74  76  79  80  81  82  83  85  86  89  90  91
#&gt;  [55]  92  93  94  95  96  97  98  99 100 101 103 104 105 106 109 110 111 113
#&gt;  [73] 114 117 119 120 123 124 125 126 128 130 131 132 133 135 136 137 138 139
#&gt;  [91] 140 141 143 144 146 148 149 150 151 154 155 157 158 160 161 162 163 164
#&gt; [109] 165 167 168 170 171 175 176 177 178 180 182 183 184 186 187 188 189 190
#&gt; [127] 191 193 194 196 197 198 200
#&gt; 
#&gt; [[2]]$app
#&gt;  [1] 102  60 115  13  77  11   7  73 166  53 181  41 147 145   3 159  40  44  29
#&gt; [20] 142 108  56  24 179  49  23 116  75 152 172 156  72  71  64   2  43  87  84
#&gt; [39] 174 112 199 153  19 122  18 134 173  47 107 129  78 121 192  21  88 195  48
#&gt; [58] 169  22  28  30 118  35 185  38   1 127
#&gt; 
#&gt; 
#&gt; [[3]]
#&gt; [[3]]$train
#&gt;   [1]   1   2   3   5   7  10  11  12  13  15  16  17  18  19  20  21  22  23
#&gt;  [19]  24  25  26  27  28  29  30  31  34  35  36  37  38  39  40  41  42  43
#&gt;  [37]  44  45  46  47  48  49  53  54  55  56  57  58  59  60  61  63  64  67
#&gt;  [55]  71  72  73  75  77  78  80  83  84  87  88  90  93  94  95  96  99 102
#&gt;  [73] 104 105 107 108 112 114 115 116 118 120 121 122 123 127 128 129 130 134
#&gt;  [91] 137 140 141 142 143 144 145 146 147 149 152 153 156 157 159 160 161 162
#&gt; [109] 164 165 166 167 168 169 170 171 172 173 174 175 177 179 180 181 185 187
#&gt; [127] 188 192 194 195 198 199 200
#&gt; 
#&gt; [[3]]$app
#&gt;  [1] 103  14 101  97  32 189 151  51 109 163   4  82 178 191 182 139 113  85  74
#&gt; [20]  66 132  52  89 133  79 193 135 111 197  92 158 110 176  33 131 100 150  65
#&gt; [39] 154 126  62  50   6 196  91 155   8 119 183  86 125 138 117  68  76 106 186
#&gt; [58] 184 124  70 190 148  81  98  69 136   9
#&gt; 
#&gt; 
#&gt; attr(,"splitmethod")
#&gt; [1] "kwaycross"</div><div class='input'>
<span class='co'># longer example</span>
<span class='co'># helper fns</span>
<span class='co'># fit models using experiment plan to estimate out of sample behavior</span>
<span class='no'>fitModelAndApply</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>trainData</span>,<span class='no'>applicaitonData</span>) {
   <span class='no'>model</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://www.rdocumentation.org/packages/stats/topics/lm'>lm</a></span>(<span class='no'>y</span>~<span class='no'>x</span>,<span class='kw'>data</span><span class='kw'>=</span><span class='no'>trainData</span>)
   <span class='fu'><a href='https://www.rdocumentation.org/packages/stats/topics/predict'>predict</a></span>(<span class='no'>model</span>,<span class='kw'>newdata</span><span class='kw'>=</span><span class='no'>applicaitonData</span>)
}
<span class='no'>simulateOutOfSampleTrainEval</span> <span class='kw'>&lt;-</span> <span class='kw'>function</span>(<span class='no'>d</span>,<span class='no'>fitApplyFn</span>) {
   <span class='no'>eSets</span> <span class='kw'>&lt;-</span> <span class='fu'>buildEvalSets</span>(<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/nrow'>nrow</a></span>(<span class='no'>d</span>))
   <span class='no'>evals</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/lapply'>lapply</a></span>(<span class='no'>eSets</span>,
      <span class='kw'>function</span>(<span class='no'>ei</span>) { <span class='fu'>fitApplyFn</span>(<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>train</span>,],<span class='no'>d</span>[<span class='no'>ei</span>$<span class='no'>app</span>,]) })
   <span class='no'>pred</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/numeric'>numeric</a></span>(<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/nrow'>nrow</a></span>(<span class='no'>d</span>))
   <span class='kw'>for</span>(<span class='no'>eii</span> <span class='kw'>in</span> <span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/seq'>seq_len</a></span>(<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/length'>length</a></span>(<span class='no'>eSets</span>))) {
     <span class='no'>pred</span>[<span class='no'>eSets</span><span class='kw'>[[</span><span class='no'>eii</span>]]$<span class='no'>app</span>] <span class='kw'>&lt;-</span> <span class='no'>evals</span><span class='kw'>[[</span><span class='no'>eii</span>]]
   }
   <span class='no'>pred</span>
}

<span class='co'># run the experiment</span>
<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/Random'>set.seed</a></span>(<span class='fl'>2352356</span>)
<span class='co'># example data</span>
<span class='no'>d</span> <span class='kw'>&lt;-</span> <span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/data.frame'>data.frame</a></span>(<span class='kw'>x</span><span class='kw'>=</span><span class='fu'><a href='https://www.rdocumentation.org/packages/stats/topics/Normal'>rnorm</a></span>(<span class='fl'>5</span>),<span class='kw'>y</span><span class='kw'>=</span><span class='fu'><a href='https://www.rdocumentation.org/packages/stats/topics/Normal'>rnorm</a></span>(<span class='fl'>5</span>),
        <span class='kw'>outOfSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>,<span class='kw'>inSampleEst</span><span class='kw'>=</span><span class='fl'>NA</span>)

<span class='co'># fit model on all data</span>
<span class='no'>d</span>$<span class='no'>inSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>fitModelAndApply</span>(<span class='no'>d</span>,<span class='no'>d</span>)
<span class='co'># compute in-sample R^2 (above zero, falsely shows a </span>
<span class='co'>#   relation until we adjust for degrees of freedom)</span>
<span class='fl'>1</span>-<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/sum'>sum</a></span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>inSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/sum'>sum</a></span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/mean'>mean</a></span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] 0.4193942</div><div class='input'>
<span class='no'>d</span>$<span class='no'>outOfSampleEst</span> <span class='kw'>&lt;-</span> <span class='fu'>simulateOutOfSampleTrainEval</span>(<span class='no'>d</span>,<span class='no'>fitModelAndApply</span>)
<span class='co'># compute out-sample R^2 (not positive, </span>
<span class='co'>#  evidence of no relation)</span>
<span class='fl'>1</span>-<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/sum'>sum</a></span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='no'>d</span>$<span class='no'>outOfSampleEst</span>)^<span class='fl'>2</span>)/<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/sum'>sum</a></span>((<span class='no'>d</span>$<span class='no'>y</span>-<span class='fu'><a href='https://www.rdocumentation.org/packages/base/topics/mean'>mean</a></span>(<span class='no'>d</span>$<span class='no'>y</span>))^<span class='fl'>2</span>)</div><div class='output co'>#&gt; [1] -3.873148</div><div class='input'>
</div></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      <li><a href="#value">Value</a></li>
      <li><a href="#details">Details</a></li>
      <li><a href="#see-also">See also</a></li>
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by John Mount, Nina Zumel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
   </div>

  

  </body>
</html>

